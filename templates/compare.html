<!DOCTYPE html>
<html lang="en">
  <head>
        <link rel="icon" type="image/png" href="/static/image/system_logo.png">
    <link rel="shortcut icon" type="image/png" href="/static/image/system_logo.png">
    <link rel="icon" type="image/x-icon" href="/static/image/system_logo.png">
    <link rel="apple-touch-icon" href="/static/image/system_logo.png">
    <!-- Cache busting query parameter -->
    <link rel="icon" type="image/png" href="/static/image/system_logo.png?v=2">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quick Deals – Product Comparison</title>
    <style>
      :root {
        --primary: #6a11cb;
        --secondary: #2575fc;
        --accent: #ff9800;
        --success: #4caf50;
        --warning: #ff5722;
        --light-bg: #f8f9fa;
        --dark-text: #333;
        --light-text: #fff;
        --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        --shadow-hover: 0 8px 25px rgba(0, 0, 0, 0.15);
        --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        --bounce: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      }

      * {
        box-sizing: border-box;
      }

      body {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        min-height: 100vh;
        margin: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        color: var(--dark-text);
        overflow-x: hidden;
      }

      /* Header Styles */
      .header {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        padding: 8px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: var(--shadow);
        z-index: 1000;
        height: 60px;
        transition: var(--transition);
      }

      .logo {
 display: flex;
        align-items: center;
        gap: 12px;
      }

          .logo-img {
        width: 65px;
        height: 35px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      }

      .logo-text {
        font-size: 24px;
        font-weight: 700;
        background: linear-gradient(135deg, #667eea, #764ba2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }


      .nav-links {
        display: flex;
        align-items: center;
      }

      .nav-links a {
        color: #444;
        text-decoration: none;
        margin-left: 15px;
        font-weight: 500;
        transition: var(--transition);
        position: relative;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .nav-links a:hover {
        color: var(--primary);
      }

      .nav-links a::after {
        content: "";
        position: absolute;
        bottom: -5px;
        left: 0;
        width: 0;
        height: 2px;
        background: var(--primary);
        transition: var(--transition);
      }

      .nav-links a:hover::after {
        width: 100%;
      }

      .cart-count {
        background: var(--accent);
        color: white;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: absolute;
        top: -8px;
        right: -8px;
      }

      /* Mobile Navigation */
      .mobile-nav {
        display: none;
        flex-direction: column;
        position: relative;
      }

      .hamburger {
        display: none;
        flex-direction: column;
        cursor: pointer;
        padding: 5px;
        gap: 3px;
      }

      .hamburger span {
        width: 25px;
        height: 3px;
        background: var(--primary);
        border-radius: 2px;
        transition: var(--transition);
      }

      .mobile-nav-slider {
        position: fixed;
        top: 0;
        right: -100%;
        width: 280px;
        height: 100vh;
        background: linear-gradient(135deg, #ff6b6b, #ffa726);
        box-shadow: -5px 0 25px rgba(0, 0, 0, 0.2);
        z-index: 2000;
        transition: var(--transition);
        padding: 80px 30px 30px;
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .mobile-nav-slider.active {
        right: 0;
      }

      .mobile-nav-slider a {
        color: white;
        text-decoration: none;
        font-size: 18px;
        font-weight: 500;
        padding: 15px 20px;
        border-radius: 10px;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 12px;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
      }

      .mobile-nav-slider a:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateX(-5px);
      }

      .close-slider {
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 20px;
        transition: var(--transition);
      }

      /* Chat Wrapper */
      .chat-wrapper {
        width: 100%;
        height: 100vh;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 60px 0px 0px;
        display: flex;
        flex-direction: column;
        position: fixed;
        top: 0;
        left: 0;
        z-index: 999;
      }

      .chat-container {
        max-width: 1400px;
        width: 100%;
        height: 100%;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        background: white;
        border-radius: 0px;
        box-shadow: var(--shadow);
        overflow: hidden;
      }

      .chat-header {
     background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: white;
  padding: 2px 10px; /* Reduced padding */
  text-align: center;
  position: relative;
  overflow: hidden;
  font-weight: 600px;
  min-height: 5px; /* Fixed height */
  display: flex;
  align-items: center;
  justify-content: center;
      }

      .chat-header::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        animation: shimmer 3s infinite;
      }

      @keyframes shimmer {
        0% {
          left: -100%;
        }
        100% {
          left: 100%;
        }
      }

      .chat-header h2 {
        margin: 0;
        font-size: 0.8rem;
        font-weight: 600;
      }

      .chat-main {
        flex: 1;
        display: flex;
        overflow: hidden;
        max-width: 100%;
      }

      .chat-box {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
        display: flex;
        flex-direction: column;
        background: #f8f9fa;
      }

      .bot-message,
      .user-message {
        border-radius: 18px;
        padding: 15px 20px;
        margin: 10px 0;
        max-width: 70%;
        line-height: 1.5;
        animation: fadeIn 0.5s ease;
        position: relative;
        font-size: 16px;
      }

      .bot-message {
        background: white;
        align-self: flex-start;
        border-bottom-left-radius: 5px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border-left: 4px solid var(--primary);
      }

      .user-message {
        background: var(--primary);
        color: var(--light-text);
        align-self: flex-end;
        border-bottom-right-radius: 5px;
        box-shadow: 0 2px 8px rgba(106, 17, 203, 0.3);
      }

      /* Products Container */
      .products-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin: 20px 0;
        padding: 10px;
        position: relative;
      }

      .product-card {
        flex: 1 1 calc(33.33% - 20px);
        background: white;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transition: var(--transition);
        border: 1px solid #eee;
        min-width: 250px;
        position: relative;
        overflow: hidden;
        opacity: 0;
        transform: translateY(20px);
        animation: slideUpProduct 0.6s ease forwards;
      }

      .product-card:nth-child(1) {
        animation-delay: 0.1s;
      }
      .product-card:nth-child(2) {
        animation-delay: 0.2s;
      }
      .product-card:nth-child(3) {
        animation-delay: 0.3s;
      }

      @keyframes slideUpProduct {
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
      }

      .product-card strong {
        color: var(--primary);
        font-size: 1.1rem;
        display: block;
        margin-bottom: 10px;
      }

      .product-feature {
        display: flex;
        justify-content: space-between;
        margin: 8px 0;
        padding: 5px 0;
        border-bottom: 1px solid #f0f0f0;
      }

      .feature-name {
        color: #666;
        font-size: 0.9rem;
      }

      .feature-value {
        color: var(--dark-text);
        font-weight: 600;
        font-size: 0.9rem;
      }

      .price-inr {
        color: #2e7d32;
        font-weight: 700;
        font-size: 0.95rem;
      }

      .price-inr::before {
        content: "₹";
        margin-right: 2px;
      }

      .product-score {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        padding: 8px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        text-align: center;
        margin-top: 10px;
      }

      .score-best {
        background: linear-gradient(135deg, #2196f3, #1976d2);
      }
      .score-good {
        background: linear-gradient(135deg, #4caf50, #45a049);
      }
      .score-average {
        background: linear-gradient(135deg, #ff9800, #f57c00);
      }

      .add-to-cart-btn {
        background: linear-gradient(135deg, #ec4899, #8b5cf6);
        color: white;
        border: none;
        padding: 12px 15px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        margin-top: 15px;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .add-to-cart-btn:hover {
        transform: translateY(-2px);
      }

      .predict-button {
        display: block;
        width: 100%;
        padding: 12px;
        font-size: 1rem;
        font-weight: 600;
        color: var(--light-text);
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        border: none;
        border-radius: 8px;
        margin-top: 20px;
        cursor: pointer;
        transition: var(--transition);
      }

      .predict-button:hover {
        transform: translateY(-2px);
      }

      /* Chat Form */
      .chat-form {
        display: flex;
        padding: 12px 15px;
        background: white;
        border-top: 1px solid #eee;
        gap: 10px;
        align-items: center;
      }

      .input-container {
        position: relative;
        flex: 1;
        display: flex;
      }

      #user-input {
        width: 100%;
        padding: 12px 50px 12px 25px;
        border: 2px solid #e0e0e0;
        border-radius: 30px;
        font-size: 15px;
        transition: var(--bounce);
        background: linear-gradient(135deg, #f8f9fa, #ffffff);
        outline: none;
      }

      #user-input:focus {
        border-color: var(--primary);
        background: linear-gradient(135deg, #ffffff, #f8f9fa);
        transform: translateY(-2px);
      }

      .input-label {
        position: absolute;
        left: 25px;
        top: 50%;
        transform: translateY(-50%);
        color: #9e9e9e;
        font-size: 15px;
        pointer-events: none;
        transition: var(--bounce);
        background: white;
        padding: 0 8px;
      }

      #user-input:focus ~ .input-label,
      #user-input:not(:placeholder-shown) ~ .input-label {
        top: 0;
        font-size: 12px;
        color: var(--primary);
        font-weight: 600;
        transform: translateY(-50%);
      }

      .input-icon {
        position: absolute;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
        color: #9e9e9e;
        transition: var(--transition);
        pointer-events: none;
      }

      .send-button {
        background: linear-gradient(135deg, var(--secondary), var(--primary));
        color: var(--light-text);
        border: none;
        padding: 12px 22px;
        border-radius: 30px;
        font-weight: 600;
        cursor: pointer;
        transition: var(--bounce);
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 15px;
      }

      .send-button:hover {
        transform: translateY(-2px);
      }

      .close-chat {
        position: absolute;
        top: 15px;
        right: 25px;
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        width: 35px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: var(--transition);
        font-size: 20px;
        z-index: 1001;
      }

      .close-chat:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: rotate(90deg);
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Responsive */
      @media (max-width: 768px) {
        .nav-links {
          display: none;
        }

        .mobile-nav {
          display: flex;
        }

        .hamburger {
          display: flex;
        }

        .product-card {
          flex: 1 1 100%;
        }

        .chat-wrapper {
          padding: 70px 10px 10px;
        }

        .chat-container {
          border-radius: 15px;
        }

        .bot-message,
        .user-message {
          max-width: 85%;
          font-size: 14px;
          padding: 12px 16px;
        }

        .chat-form {
          padding: 10px;
          gap: 8px;
        }

        #user-input {
          padding: 10px 45px 10px 20px;
          font-size: 14px;
        }

        .send-button {
          padding: 10px 12px;
          font-size: 14px;
        }

        .send-button .send-text {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <div class="header">
      <div class="logo">
        <img src="/static/image/system_logo.png" alt="Quick Deals Logo" class="logo-img">
        <span class="logo-text">Quick Deals</span>
      </div>
      <div class="nav-links">
        <a href="/">Home</a>
        <a href="#">Offers</a>
        <a href="/predict.html">Predict</a>
        <a href="#">About</a>
        <a href="/cart.html" onclick="showCartPage(); return false;">
          🛒 Cart
          <span class="cart-count" id="cartCount">0</span>
        </a>
      </div>
      <div class="mobile-nav">
        <div class="hamburger" onclick="toggleMobileNav()">
          <span></span>
          <span></span>
          <span></span>
        </div>
        <div class="mobile-nav-slider" id="mobileNavSlider">
          <button class="close-slider" onclick="toggleMobileNav()">×</button>
          <a href="#"><span>🎁</span> Offers</a>
          <a href="/"><span>🏠</span> Home</a>
          <a href="/predict.html"><span>🔮</span> Predict</a>
          <a href="#"><span>ℹ️</span> About</a>
          <a href="/cart.html">
            <span>🛒</span> Cart
            <span class="cart-count" id="mobileCartCount">0</span>
          </a>
        </div>
      </div>
    </div>

    <!-- Chat Wrapper -->
    <div class="chat-wrapper">
      <button class="close-chat" onclick="goToHome()">✕</button>
      <div class="chat-container">
        <div class="chat-header">
          <h2><b>Product Comparison</b></h2>
        </div>
        <div class="chat-main">
          <div id="chat-box" class="chat-box">
            <div class="bot-message">
              🔍 <strong>Smart Product Comparison</strong><br /><br />

              Tell me any product you're interested in, and I'll find you the
              <strong>3 best deals</strong> from top e-commerce platforms!<br /><br />

              <strong>Popular products to compare:</strong><br />
              📱 <strong>Phones:</strong> iPhone 14, iPhone 15, iPhone 16,
              iPhone 17
              <br />
              💻 <strong>Laptops:</strong> MacBook Pro, Dell XPS, HP Spectre<br />
              🎧 <strong>Headphones:</strong> Sony WH-1000XM5, AirPods Pro, Bose
              QC45<br />
              ⌚ <strong>Watches:</strong> Apple Watch, Samsung Galaxy Watch<br /><br />

              <strong>Just type the product name like:</strong><br />
              • "iPhone 16"<br />
              • "MacBook Pro M3"<br />
              • "Sony headphones"<br />
              • "Samsung S24 Ultra"<br /><br />

              <em
                >What product would you like me to find the best deals for?</em
              >
            </div>
          </div>
        </div>
        <form id="chat-form" class="chat-form">
          <div class="input-container">
            <input
              type="text"
              id="user-input"
              placeholder=" "
              autocomplete="off"
            />
            <span class="input-label">Type your message...</span>
            <div class="input-icon">💬</div>
          </div>
          <button type="submit" class="send-button">
            <span class="send-text">Send</span>
          </button>
        </form>
      </div>
    </div>

<script>
  // Cart functionality
  let cart = JSON.parse(localStorage.getItem("quickDealsCart")) || [];

  function updateCartCount() {
    const cartCount = document.getElementById("cartCount");
    const mobileCartCount = document.getElementById("mobileCartCount");
    if (cartCount) cartCount.textContent = cart.length;
    if (mobileCartCount) mobileCartCount.textContent = cart.length;
  }

  function addToCart(product) {
    const existingProductIndex = cart.findIndex(
      (item) =>
        item.platform === product.platform && item.name === product.name
    );

    if (existingProductIndex === -1) {
      cart.push({
        ...product,
        image: product.image || product.base_image_url,
        quantity: 1,
        addedAt: new Date().toISOString(),
      });
      localStorage.setItem("quickDealsCart", JSON.stringify(cart));
      updateCartCount();
      showCartNotification();
    } else {
      cart[existingProductIndex].quantity += 1;
      localStorage.setItem("quickDealsCart", JSON.stringify(cart));
      updateCartCount();
      showCartNotification();
    }
  }

  function showCartNotification() {
    // Simple notification implementation
    alert("Product added to cart!");
  }

  function goToHome() {
    window.location.href = "/";
  }

  // Mobile Navigation
  function toggleMobileNav() {
    const slider = document.getElementById("mobileNavSlider");
    slider.classList.toggle("active");
  }

  // Chat functionality
  const chatBox = document.getElementById("chat-box");
  const chatForm = document.getElementById("chat-form");
  const userInput = document.getElementById("user-input");

  function addMessage(sender, text) {
    const messageDiv = document.createElement("div");
    messageDiv.className = `${sender}-message`;
    if (sender === "bot") {
      text = text.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");
    }
    messageDiv.innerHTML = text;
    chatBox.appendChild(messageDiv);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  // Add typing indicator functions
  function addTypingIndicator() {
    if (document.getElementById("typing-indicator")) return;
    const typingDiv = document.createElement("div");
    typingDiv.className = "bot-message";
    typingDiv.id = "typing-indicator";
    typingDiv.innerHTML =
      '<div style="display: flex; gap: 5px; align-items: center;"><div style="width: 8px; height: 8px; background: #666; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both;"></div><div style="width: 8px; height: 8px; background: #666; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; animation-delay: 0.16s;"></div><div style="width: 8px; height: 8px; background: #666; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; animation-delay: 0.32s;"></div></div>';
    chatBox.appendChild(typingDiv);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function removeTypingIndicator() {
    const indicator = document.getElementById("typing-indicator");
    if (indicator) {
      indicator.remove();
    }
  }

  // Fixed product search function for your JSON structure
  function findSpecificProducts(message, allProducts) {
    const query = message.toLowerCase().trim();
    const results = [];
    
    console.log('Searching for:', query);
    console.log('Total products:', allProducts.length);

    // Extract numbers from query for version matching
    const queryNumbers = query.match(/\d+/g) || [];
    const queryNumber = queryNumbers.length > 0 ? queryNumbers[0] : null;

    // Check if we have products data
    if (!allProducts || !Array.isArray(allProducts)) {
      console.error('No products array found in data');
      return [];
    }

    // Search through all products
    allProducts.forEach(product => {
      if (!product || !product.product_name) return;
      
      const productName = product.product_name.toLowerCase();
      let score = 0;

      console.log('Checking product:', productName);

      // 1. Exact match (highest priority)
      if (productName === query) {
        score += 1000;
        console.log('Exact match found:', productName);
      }

      // 2. Contains exact query
      if (productName.includes(query)) {
        score += 500;
        console.log('Partial match found:', productName);
      }

      // 3. Number matching for versions
      if (queryNumber) {
        const productNumbers = productName.match(/\d+/g) || [];
        if (productNumbers.includes(queryNumber)) {
          score += 400;
          console.log('Number match found:', productName);
        }
      }

      // 4. Word-by-word matching
      const queryWords = query.split(/\s+/).filter(word => word.length > 2);
      const productWords = productName.split(/\s+/);

      queryWords.forEach(word => {
        if (productWords.includes(word)) {
          score += 100;
        } else if (productName.includes(word)) {
          score += 50;
        }
      });

      // 5. Brand matching
      const brands = ["iphone", "macbook", "samsung", "sony", "bose", "hp", "dell", "lenovo", "google", "oneplus", "apple", "asus", "lg", "microsoft", "amazon"];
      brands.forEach(brand => {
        if (query.includes(brand) && productName.includes(brand)) {
          score += 80;
        }
      });

      // 6. Category matching
      if (product.category && query.includes(product.category)) {
        score += 60;
      }

      // Add to results if score is above threshold
      if (score > 100) {
        console.log('Product matched with score:', score, productName);
        
        // Get the first variant and its offers
        if (product.variants && product.variants.length > 0) {
          const variant = product.variants[0];
          const offers = variant.offers ? variant.offers.slice(0, 3) : []; // Take top 3 offers
          
          // Convert offers to product format for display
          const productResults = offers.map(offer => ({
            id: product.product_id,
            name: product.product_name,
            platform: offer.seller_name || 'Unknown Seller',
            price: `₹${offer.price?.toLocaleString('en-IN') || 'N/A'}`,
            rating: offer.rating || 0,
            rating_count: offer.rating_count || 0,
            delivery_in_days: offer.delivery_in_days || 0,
            is_trusted: offer.is_trusted_seller || false,
            discount_percent: offer.discount_percent || 0,
            image: product.base_image_url,
            category: product.category,
            description: product.description || 'No description available',
            specifications: variant.specifications || {},
            searchScore: score
          }));

          results.push(...productResults);
          console.log('Added product results:', productResults.length);
        }
      }
    });

    console.log('Total results found:', results.length);
    
    // Sort by score and return top results
    return results
      .sort((a, b) => b.searchScore - a.searchScore)
      .slice(0, 9) // Return up to 9 results (3 products × 3 sellers)
      .map(({ searchScore, ...product }) => product);
  }

  // Modified to work with your data structure
  function ensureThreeVariants(products) {
    if (!products || products.length === 0) return [];

    // Group products by name to get different sellers for same product
    const productsByName = {};
    
    products.forEach(product => {
      if (!productsByName[product.name]) {
        productsByName[product.name] = [];
      }
      productsByName[product.name].push(product);
    });

    // Get the product with most sellers
    let bestProductGroup = null;
    Object.values(productsByName).forEach(group => {
      if (!bestProductGroup || group.length > bestProductGroup.length) {
        bestProductGroup = group;
      }
    });

    if (bestProductGroup && bestProductGroup.length >= 3) {
      return bestProductGroup.slice(0, 3);
    }

    // If we don't have 3 different sellers, create variations
    const baseProduct = products[0];
    const sellers = ['Amazon', 'Flipkart', 'Reliance Digital'];
    
    return sellers.map((seller, index) => {
      const priceVariation = [0, -0.05, 0.03][index]; // Different price variations
      const basePrice = parseFloat(String(baseProduct.price).replace(/[₹,]/g, '')) || 0;
      const variedPrice = Math.max(1, Math.round(basePrice * (1 + priceVariation)));
      
      return {
        ...baseProduct,
        platform: seller,
        price: `₹${variedPrice.toLocaleString('en-IN')}`,
        rating: Math.max(3.5, Math.min(5, (baseProduct.rating || 4) + (index === 1 ? -0.1 : index === 2 ? 0.1 : 0))),
        is_trusted: index !== 1 // Make middle one slightly less trusted for realism
      };
    });
  }

  // Price Drop Prediction Modal
  function showPriceDropPrediction(product) {
    // Create modal overlay
    const modalOverlay = document.createElement("div");
    modalOverlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    `;

    // Create modal content
    const modalContent = document.createElement("div");
    modalContent.style.cssText = `
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      max-width: 400px;
      width: 90%;
      text-align: center;
    `;

    // Safely parse price
    let priceValue = 0;
    try {
      if (product.price) {
        priceValue = parseInt(product.price.replace(/[₹,]/g, "")) || 0;
      }
    } catch (e) {
      console.log("Error parsing price:", e);
    }

    modalContent.innerHTML = `
      <h3 style="color: #6a11cb; margin-bottom: 15px;">🔮 Price Drop Prediction</h3>
      <p style="margin-bottom: 20px; line-height: 1.5;">
        Based on our AI analysis for <strong>${product.name || product.platform || "Product"}</strong>:
      </p>
      <div style="background: linear-gradient(135deg, #4CAF50, #45a049); color: white; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
        <div style="font-size: 24px; font-weight: bold; margin-bottom: 5px;">24%</div>
        <div>Probability of price drop in next 7 days</div>
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
        <div style="background: #f8f9fa; padding: 10px; border-radius: 8px;">
          <div style="font-weight: bold; color: #6a11cb;">Expected Drop</div>
          <div>₹${Math.floor(priceValue * 0.15)}</div>
        </div>
        <div style="background: #f8f9fa; padding: 10px; border-radius: 8px;">
          <div style="font-weight: bold; color: #6a11cb;">Best Time</div>
          <div>Next Week</div>
        </div>
      </div>
      <button onclick="this.closest('div[style*=\"position: fixed\"]').remove(); showPriceDropNotification()"
        style="background: linear-gradient(135deg, #6a11cb, #2575fc); color: white; border: none; padding: 12px 25px; border-radius: 25px; font-weight: bold; cursor: pointer; width: 100%;">
        Enable Price Alerts
      </button>
    `;

    modalOverlay.appendChild(modalContent);
    document.body.appendChild(modalOverlay);

    // Close modal when clicking outside
    modalOverlay.addEventListener("click", function (e) {
      if (e.target === modalOverlay) {
        modalOverlay.remove();
      }
    });
  }

  // Green notification for left side
  function showPriceDropNotification() {
    const notification = document.createElement("div");
    notification.style.cssText = `
      position: fixed;
      top: 100px;
      left: 20px;
      background: linear-gradient(135deg, #4CAF50, #45a049);
      color: white;
      padding: 15px 20px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 10px;
      animation: slideInLeft 0.5s ease;
    `;

    notification.innerHTML = `
      <span style="font-size: 20px;">🔔</span>
      <div>
        <div style="font-weight: bold;">Price Alert Set!</div>
        <div style="font-size: 12px;">We'll notify you of price drops</div>
      </div>
    `;

    document.body.appendChild(notification);

    // Remove notification after 3 seconds
    setTimeout(() => {
      notification.style.animation = "slideOutLeft 0.5s ease";
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 500);
    }, 3000);
  }

  // Add CSS for animations
  const style = document.createElement("style");
  style.textContent = `
    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }

    @keyframes slideInLeft {
      from {
        transform: translateX(-100px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOutLeft {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(-100px);
        opacity: 0;
      }
    }

    .predict-price-btn {
      background: linear-gradient(135deg, #ff6b6b, #ffa726);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 25px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 15px;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
    }

    .predict-price-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
    }
  `;
  document.head.appendChild(style);

  function getScoreRating(score) {
    // Only Good and Best - no Average
    if (score >= 8.5) return { text: "Best", class: "score-best" };
    return { text: "Good", class: "score-good" };
  }

  // Helper function to get category images
  function getCategoryImage(category) {
    const categoryImages = {
      phones:
        "https://images.unsplash.com/photo-1511707171634-5f897ff02aa9?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8M3x8cGhvbmV8ZW58MHx8MHx8fDA%3D&w=1000&q=80",
      laptops:
        "https://images.unsplash.com/photo-1496181133206-80ce9b88a853?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8bGFwdG9wfGVufDB8fDB8fHww&w=1000&q=80",
      headphones:
        "https://images.unsplash.com/photo-1505740420928-5e560c06d30e?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8M3x8aGVhZHBob25lc3xlbnwwfHwwfHx8MA%3D%3D&w=1000&q=80",
      watches:
        "https://images.unsplash.com/photo-1544117519-31a4b719223d?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8c21hcnR3YXRjaHxlbnwwfHwwfHx8MA%3D%3D&w=1000&q=80",
      earbuds:
        "https://images.unsplash.com/photo-1590658165737-15a047b8b5e3?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8ZWFyYnVkc3xlbnwwfHwwfHx8MA%3D%3D&w=1000&q=80",
      smart_tv:
        "https://images.unsplash.com/photo-1593359677879-a4bb92f829d1?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8dHZ8ZW58MHx8MHx8fDA%3D&w=1000&q=80",
      gaming_consoles:
        "https://images.unsplash.com/photo-1606144042614-b2417e99c4e3?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8Z2FtaW5nJTIwY29uc29sZXxlbnwwfHwwfHx8MA%3D%3D&w=1000&q=80",
      smart_home:
        "https://images.unsplash.com/photo-1558089687-db4b18aed183?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8c21hcnQlMjBob21lfGVufDB8fDB8fHww&w=1000&q=80"
    };
    return (
      categoryImages[category] ||
      "https://images.unsplash.com/photo-1563013541-5a61e9a60656?w=500&q=80"
    );
  }

  function renderProductComparison(data) {
    const container = document.createElement("div");
    container.className = "bot-message";

    let headerHtml = "";
    if (data.image) {
      headerHtml += `<img src="${data.image}" alt="Product" style="width: 100%; max-width: 200px; border-radius: 10px; margin-bottom: 15px; display: block; margin-left: auto; margin-right: auto;">`;
    }
    if (data.description) {
      headerHtml += `<p style="margin-bottom: 20px; text-align: center; line-height: 1.5; font-weight: 500;">${data.description}</p>`;
    }

    let productsHtml = data.products
      .map((product, index) => {
        // Generate scores between 8.0 and 10.0
        const randomScore = Math.random() * 2 + 8.0;
        const scoreRating = getScoreRating(randomScore);

        // Parse price for calculations
        const priceValue = parseFloat(String(product.price).replace(/[₹,]/g, '')) || 0;

        // Build specifications HTML
        let specsHtml = "";
        if (product.specifications) {
          for (const [key, value] of Object.entries(product.specifications)) {
            if (typeof value !== 'object' && key !== 'warranty_months' && key !== 'is_replaceable') {
              specsHtml += `
                <div class="product-feature">
                  <span class="feature-name">${key.replace(/_/g, ' ')}</span>
                  <span class="feature-value">${value}</span>
                </div>
              `;
            }
          }
        }

        // Add essential product info
        specsHtml += `
          <div class="product-feature">
            <span class="feature-name">Platform</span>
            <span class="feature-value">${product.platform}</span>
          </div>
          <div class="product-feature">
            <span class="feature-name">Rating</span>
            <span class="feature-value">${product.rating} ★ (${product.rating_count?.toLocaleString() || 'N/A'} reviews)</span>
          </div>
          <div class="product-feature">
            <span class="feature-name">Delivery</span>
            <span class="feature-value">${product.delivery_in_days} days</span>
          </div>
          <div class="product-feature">
            <span class="feature-name">Trusted Seller</span>
            <span class="feature-value">${product.is_trusted ? "✅ Yes" : "❌ No"}</span>
          </div>
          ${product.discount_percent > 0 ? `
          <div class="product-feature">
            <span class="feature-name">Discount</span>
            <span class="feature-value" style="color: #4CAF50; font-weight: bold;">${product.discount_percent}% OFF</span>
          </div>
          ` : ''}
        `;

        const cartProductData = {
          name: product.name,
          platform: product.platform,
          price: product.price,
          rating: product.rating,
          score: randomScore,
          image: data.image || product.image,
          specifications: product.specifications,
          delivery_in_days: product.delivery_in_days,
          is_trusted: product.is_trusted,
          discount_percent: product.discount_percent
        };

        return `
          <div class="product-card">
            <strong>${product.name}</strong>
            <div class="product-feature">
              <span class="feature-name">Platform</span>
              <span class="feature-value">${product.platform}</span>
            </div>
            <div class="product-feature">
              <span class="feature-name">Price</span>
              <span class="feature-value price-inr" style="font-weight: bold; color: #6a11cb;">${product.price}</span>
            </div>
            ${specsHtml}
            <div class="product-score ${scoreRating.class}">
              Our Score: ${scoreRating.text} (${randomScore.toFixed(1)}/10)
            </div>
            <button class="add-to-cart-btn" onclick="addToCart(${JSON.stringify(
              cartProductData
            ).replace(/"/g, "&quot;")})">
              + Add to Cart
            </button>
            <button class="predict-price-btn" onclick="showPriceDropPrediction(${JSON.stringify(
              cartProductData
            ).replace(/"/g, "&quot;")})">
              🔮 Predict Price Drop
            </button>
          </div>
        `;
      })
      .join("");

    container.innerHTML = `
      ${headerHtml}
      <div style="text-align: center; margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 10px;">
        <strong>🎯 AI-Powered Best Deals</strong><br>
        Top ${data.products.length} recommendations based on price, rating & delivery
      </div>
      <div class="products-container">
        ${productsHtml}
      </div>
    `;
    chatBox.appendChild(container);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  // Enhanced chat form submission for specific product search
  chatForm.addEventListener("submit", async function (e) {
    e.preventDefault();
    const message = userInput.value.trim();
    if (!message) return;

    addMessage("user", message);
    userInput.value = "";

    try {
      // Show typing indicator
      addTypingIndicator();

      // Try the AI backend first (XGBoost model)
      const response = await fetch("/chat", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          message: message,
        }),
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const data = await response.json();
      removeTypingIndicator();

      if (data.products && data.products.length > 0) {
        // AI backend found products - ensure we have three seller variants and display them
        const aiVariants = ensureThreeVariants(data.products);
        const comparisonData = {
          image: getCategoryImage((aiVariants[0] && aiVariants[0].category) || data.category || 'phones'),
          description: data.description || `AI search results for: ${message}`,
          products: aiVariants,
        };
        renderProductComparison(comparisonData);
      } else {
        // Fallback to local search
        addMessage(
          "bot",
          `🔍 AI search didn't find exact matches. Trying local search for "${message}"...`
        );

        // Show typing indicator for local search
        addTypingIndicator();

        try {
          // Call backend endpoint that serves transformed products JSON
          const productsResponse = await fetch("/products.json");
          if (productsResponse.ok) {
            const allProductsData = await productsResponse.json();
            
            // Extract the products array from the JSON structure
            const allProducts = allProductsData.products || [];
            
            // For debugging: log the first few product names loaded
            try {
              const sampleNames = allProducts.slice(0, 3).map(p => p.product_name);
              console.debug('Loaded products sample:', sampleNames);
            } catch (dbgErr) {
              console.debug('Product sample logging failed:', dbgErr);
            }

            // FIXED: Pass the products array directly, not the whole data object
            const foundProducts = findSpecificProducts(message, allProducts);
            removeTypingIndicator();

            if (foundProducts.length > 0) {
              addMessage(
                "bot",
                `🔍 Found ${foundProducts.length} matching products for "${message}":`
              );

              const comparisonData = {
                image: getCategoryImage(foundProducts[0].category),
                description: foundProducts[0].description || `Comparison results for: ${message}`,
                products: ensureThreeVariants(foundProducts),
              };

              renderProductComparison(comparisonData);
            } else {
              addMessage(
                "bot",
                "❌ Sorry, I couldn't find that product in our database. Try searching for products like 'iPhone 16', 'MacBook Pro', 'Sony headphones', etc."
              );
            }
          } else {
            removeTypingIndicator();
            addMessage(
              "bot",
              "❌ Local product search is currently unavailable. Please try the AI search again."
            );
          }
        } catch (localError) {
          removeTypingIndicator();
          console.error("Local search error:", localError);
          addMessage(
            "bot",
            "❌ Sorry, I couldn't find that product. Please try a different search term."
          );
        }
      }
    } catch (error) {
      removeTypingIndicator();
      console.error("Error searching products:", error);
      addMessage(
        "bot",
        "❌ Sorry, I encountered an error while searching. Please try again."
      );
    }
  });

  // Initialize
  document.addEventListener("DOMContentLoaded", function () {
    updateCartCount();
    // Focus on chat input
    setTimeout(() => {
      if (userInput) {
        userInput.focus();
      }
    }, 500);
  });
</script>
  </body>
</html>
